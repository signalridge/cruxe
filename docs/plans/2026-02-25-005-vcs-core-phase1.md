# 005 VCS Core Phase 1 Foundation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Land the 005 Phase-1 foundational primitives (VCS crate + state schema/CRUD extensions) with passing tests and no behavior regression in existing 001-004 flows.

**Architecture:** Add a dedicated `codecompass-vcs` crate for Git/VCS abstractions and worktree management primitives. Extend `codecompass-state` schema and modules to support `worktree_leases`, richer `branch_state`, and typed `branch_tombstones` operations. Keep compatibility by making new DB columns defaulted and non-breaking.

**Tech Stack:** Rust workspace crates, `git2`, `rusqlite`, existing `codecompass-core` error types, existing workspace test harness.

---

### Task 1: Add `codecompass-vcs` crate skeleton and workspace wiring

**Files:**
- Create: `crates/codecompass-vcs/Cargo.toml`
- Create: `crates/codecompass-vcs/src/lib.rs`
- Modify: `Cargo.toml`

**Step 1: Write failing test**
- Add a minimal crate-level unit test in `crates/codecompass-vcs/src/lib.rs` that imports public modules and asserts exported types compile and are callable.

**Step 2: Run test to verify it fails**
- Run: `cargo test -p codecompass-vcs`
- Expected: FAIL because crate is not yet in workspace / files missing.

**Step 3: Write minimal implementation**
- Add crate files and workspace member entry.

**Step 4: Run test to verify it passes**
- Run: `cargo test -p codecompass-vcs`

---

### Task 2: Implement VCS adapter and diff domain primitives

**Files:**
- Create: `crates/codecompass-vcs/src/adapter.rs`
- Create: `crates/codecompass-vcs/src/diff.rs`
- Create: `crates/codecompass-vcs/src/git2_adapter.rs`
- Modify: `crates/codecompass-vcs/src/lib.rs`

**Step 1: Write failing test**
- Add unit tests in `git2_adapter.rs` for:
  - repo detection
  - resolve head commit
  - list refs
  - merge base
  - diff name-status classification
  - ancestry check
  - ensure worktree creation

**Step 2: Run test to verify it fails**
- Run targeted tests in `codecompass-vcs`.
- Expected: FAIL due missing trait/implementation.

**Step 3: Write minimal implementation**
- Define `VcsAdapter` trait with `DetectRepo`, `ResolveHEAD`, `ListRefs`, `MergeBase`, `DiffNameStatus`, `IsAncestor`, `EnsureWorktree`.
- Define `DiffEntry` and `FileChangeKind`.
- Implement `Git2VcsAdapter`.

**Step 4: Run test to verify it passes**
- Run: `cargo test -p codecompass-vcs`

---

### Task 3: Extend state schema for leases and richer branch metadata

**Files:**
- Modify: `crates/codecompass-state/src/schema.rs`
- Modify: `crates/codecompass-state/src/lib.rs`

**Step 1: Write failing test**
- Add schema tests asserting:
  - `worktree_leases` table exists
  - `branch_state` has `symbol_count`, `is_default_branch`, `status`, `eviction_eligible_at`
  - `branch_tombstones` has `tombstone_type`, `created_at`

**Step 2: Run test to verify it fails**
- Run: `cargo test -p codecompass-state schema::tests`
- Expected: FAIL on missing columns/table.

**Step 3: Write minimal implementation**
- Add migration and baseline SQL updates with defaults/idempotency.

**Step 4: Run test to verify it passes**
- Run: `cargo test -p codecompass-state schema::tests`

---

### Task 4: Add `worktree_leases` and `tombstones` state CRUD modules

**Files:**
- Create: `crates/codecompass-state/src/worktree_leases.rs`
- Create: `crates/codecompass-state/src/tombstones.rs`
- Modify: `crates/codecompass-state/src/lib.rs`

**Step 1: Write failing test**
- Add CRUD tests for:
  - create/get
  - update refcount / status
  - stale listing
  - tombstone bulk upsert / list / delete-for-ref

**Step 2: Run test to verify it fails**
- Run targeted tests in `codecompass-state`.

**Step 3: Write minimal implementation**
- Add modules + exports.

**Step 4: Run test to verify it passes**
- Run targeted tests and full crate tests.

---

### Task 5: Extend `branch_state` model/operations with compatibility

**Files:**
- Modify: `crates/codecompass-state/src/branch_state.rs`
- Modify: call sites:
  - `crates/codecompass-cli/src/commands/index.rs`
  - `crates/codecompass-query/src/freshness.rs`
  - `crates/codecompass-mcp/src/server/tests.rs`

**Step 1: Write failing test**
- Add tests for new operations:
  - `set_status`
  - `get_by_status`
  - `mark_eviction_eligible`

**Step 2: Run test to verify it fails**
- Run targeted `branch_state` tests.

**Step 3: Write minimal implementation**
- Add struct fields and SQL upsert/select updates.
- Update existing call sites with defaults.

**Step 4: Run test to verify it passes**
- Run: `cargo test -p codecompass-state branch_state::tests`

---

### Task 6: Add lightweight worktree manager in `codecompass-vcs`

**Files:**
- Create: `crates/codecompass-vcs/src/worktree.rs`
- Modify: `crates/codecompass-vcs/src/lib.rs`

**Step 1: Write failing test**
- Add tests for:
  - lease acquisition
  - release/refcount behavior
  - stale cleanup

**Step 2: Run test to verify it fails**
- Run targeted `codecompass-vcs` tests.

**Step 3: Write minimal implementation**
- Implement manager with deterministic worktree path normalization and lease-backed behavior.

**Step 4: Run test to verify it passes**
- Run: `cargo test -p codecompass-vcs`

---

### Task 7: Full verification and docs touch

**Files:**
- Optionally update: `specs/005-vcs-core/tasks.md` progress markers (only if requested in this session)

**Step 1: Run full checks**
- `cargo fmt --all --check`
- `cargo clippy --workspace -- -D warnings`
- `cargo test --workspace`

**Step 2: Confirm no regression**
- Validate existing 001-004 tests remain green.


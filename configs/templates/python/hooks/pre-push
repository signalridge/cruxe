#!/usr/bin/env bash
set -u

log_dir="${HOME}/.codecompass/logs"
log_file="${log_dir}/hook.log"
mkdir -p "$log_dir"

workspace="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

{
  echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] pre-push: workspace=${workspace}"

  if ! command -v codecompass >/dev/null 2>&1; then
    echo "codecompass not found on PATH; skipping doctor"
    exit 0
  fi

  if codecompass doctor --path "$workspace"; then
    echo "codecompass doctor completed"
  else
    echo "codecompass doctor failed (non-blocking)"
  fi
} >>"$log_file" 2>&1

exit 0

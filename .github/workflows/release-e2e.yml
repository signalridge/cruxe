name: release-e2e

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  linux-musl-e2e:
    if: contains(github.ref_name, '009-test')
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.ref_name }}
    steps:
      - name: Download Linux musl artifact
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p artifacts
          gh release download "$TAG" --repo "$GITHUB_REPOSITORY" \
            --pattern 'codecompass-x86_64-unknown-linux-musl.tar.gz' --dir artifacts

      - name: Verify static linking and Linux E2E
        run: |
          set -euo pipefail
          tar -xzf artifacts/codecompass-x86_64-unknown-linux-musl.tar.gz -C artifacts
          BIN="$PWD/artifacts/codecompass-x86_64-unknown-linux-musl/codecompass"
          chmod +x "$BIN"

          "$BIN" --version
          ldd_out="$(ldd "$BIN" 2>&1 || true)"
          echo "$ldd_out"
          if echo "$ldd_out" | grep -Eq 'not found'; then
            echo "Found unresolved shared libraries" >&2
            exit 1
          fi

          mkdir -p sample/src
          cat > sample/src/lib.rs <<'RS'
          pub fn add(a: i32, b: i32) -> i32 { a + b }
          RS

          (
            cd sample
            git init -q
            git config user.name test
            git config user.email test@example.com
            git add .
            git commit -q -m 'init'
          )

          "$BIN" init --path "$PWD/sample"
          "$BIN" index --path "$PWD/sample"
          (
            cd sample
            "$BIN" search add --ref main --limit 5
          )

  windows-e2e:
    if: contains(github.ref_name, '009-test')
    runs-on: windows-2022
    env:
      TAG: ${{ github.ref_name }}
    steps:
      - name: Download Windows artifact
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          gh release download $env:TAG --repo $env:GITHUB_REPOSITORY --pattern 'codecompass-x86_64-pc-windows-msvc.zip' --dir artifacts
          Expand-Archive -Path artifacts\codecompass-x86_64-pc-windows-msvc.zip -DestinationPath artifacts -Force

      - name: Windows E2E
        shell: pwsh
        run: |
          $bin = Join-Path $pwd 'artifacts\codecompass-x86_64-pc-windows-msvc\codecompass.exe'
          & $bin --version

          New-Item -ItemType Directory -Path sample\src -Force | Out-Null
          Set-Content -Path sample\src\lib.rs -Value 'pub fn add(a: i32, b: i32) -> i32 { a + b }'

          Push-Location sample
          git init -q
          git config user.name test
          git config user.email test@example.com
          git add .
          git commit -q -m 'init'
          Pop-Location

          & $bin init --path (Resolve-Path sample)
          & $bin index --path (Resolve-Path sample)
          Push-Location sample
          & $bin search add --ref main --limit 5
          Pop-Location

  homebrew-audit-install:
    if: contains(github.ref_name, '009-test')
    runs-on: macos-14
    env:
      TAG: ${{ github.ref_name }}
    steps:
      - name: Build tap formula from release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p tap/Formula
          gh release view "$TAG" --repo "$GITHUB_REPOSITORY" --json assets > assets.json

          pick_name() {
            local pattern="$1"
            jq -r --arg pattern "$pattern" '.assets[] | select(.name | test($pattern)) | .name' assets.json | head -n 1
          }

          pick_sha() {
            local name="$1"
            jq -r --arg name "$name" '.assets[] | select(.name == $name) | (.digest | sub("^sha256:"; ""))' assets.json
          }

          mac_arm="$(pick_name 'aarch64-apple-darwin\\.tar\\.gz$')"
          mac_x86="$(pick_name 'x86_64-apple-darwin\\.tar\\.gz$')"
          linux_arm="$(pick_name 'aarch64-unknown-linux-(musl|gnu)\\.tar\\.gz$')"
          linux_x86="$(pick_name 'x86_64-unknown-linux-(musl|gnu)\\.tar\\.gz$')"

          mac_arm_sha="$(pick_sha "$mac_arm")"
          mac_x86_sha="$(pick_sha "$mac_x86")"
          linux_arm_sha="$(pick_sha "$linux_arm")"
          linux_x86_sha="$(pick_sha "$linux_x86")"

          cat > tap/Formula/codecompass.rb <<RUBY
          class Codecompass < Formula
            desc "Code search and navigation engine for AI coding assistants"
            homepage "https://github.com/signalridge/codecompass"
            version "${TAG#v}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${mac_arm}"
                sha256 "${mac_arm_sha}"
              else
                url "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${mac_x86}"
                sha256 "${mac_x86_sha}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${linux_arm}"
                sha256 "${linux_arm_sha}"
              else
                url "https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${linux_x86}"
                sha256 "${linux_x86_sha}"
              end
            end

            def install
              bin.install "codecompass"
            end

            test do
              output = shell_output("#{bin}/codecompass --version")
              assert_match(version.to_s, output)
            end
          end
          RUBY

      - name: Homebrew audit and install verification
        run: |
          set -euo pipefail
          brew untap signalridge/tap >/dev/null 2>&1 || true
          brew tap --custom-remote signalridge/tap "$PWD/tap"
          brew audit --strict signalridge/tap/codecompass
          brew install --build-from-source signalridge/tap/codecompass
          codecompass --version

          mkdir -p sample/src
          cat > sample/src/lib.rs <<'RS'
          pub fn add(a: i32, b: i32) -> i32 { a + b }
          RS

          (
            cd sample
            git init -q
            git config user.name test
            git config user.email test@example.com
            git add .
            git commit -q -m 'init'
          )

          codecompass init --path "$PWD/sample"
          codecompass index --path "$PWD/sample"
          (
            cd sample
            codecompass doctor
          )

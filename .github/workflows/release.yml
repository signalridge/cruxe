name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  DIST_VERSION: 0.30.0

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dist
        run: |
          curl --proto '=https' --tlsv1.2 -LsSf \
            "https://github.com/axodotdev/cargo-dist/releases/download/v${DIST_VERSION}/cargo-dist-installer.sh" | sh
      - name: Validate release manifest
        run: dist manifest --output-format=json --no-local-paths > dist-manifest.json
      - name: Upload dist manifest
        uses: actions/upload-artifact@v4
        with:
          name: dist-manifest
          path: dist-manifest.json

  build-local-artifacts:
    needs: plan
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-14
          - target: x86_64-apple-darwin
            runner: macos-15-intel
          - target: x86_64-unknown-linux-musl
            runner: ubuntu-22.04
          - target: aarch64-unknown-linux-musl
            runner: ubuntu-22.04
          - target: x86_64-pc-windows-msvc
            runner: windows-2022

    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4
      - name: Install dist
        shell: bash
        run: |
          curl --proto '=https' --tlsv1.2 -LsSf \
            "https://github.com/axodotdev/cargo-dist/releases/download/v${DIST_VERSION}/cargo-dist-installer.sh" | sh
      - name: Install Zig (aarch64 musl)
        if: matrix.target == 'aarch64-unknown-linux-musl'
        uses: goto-bus-stop/setup-zig@v2
      - name: Install target helpers
        shell: bash
        run: |
          if [ "${{ matrix.target }}" = "aarch64-unknown-linux-musl" ]; then
            cargo install cargo-zigbuild --locked
          elif [ "${{ matrix.target }}" = "x86_64-unknown-linux-musl" ]; then
            sudo apt-get update
            sudo apt-get install -y musl-tools
          fi
      - name: Build release archives
        shell: bash
        run: dist build --target=${{ matrix.target }} --artifacts=local
      - name: Upload local artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.target }}
          path: target/distrib/*

  build-global-artifacts:
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dist
        run: |
          curl --proto '=https' --tlsv1.2 -LsSf \
            "https://github.com/axodotdev/cargo-dist/releases/download/v${DIST_VERSION}/cargo-dist-installer.sh" | sh
      - name: Build global artifacts (checksums)
        run: dist build --artifacts=global
      - name: Install git-cliff
        run: cargo install git-cliff --locked
      - name: Generate release changelog
        run: git-cliff --latest --config cliff.toml --output release-notes.md
      - name: Upload global artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-global
          path: |
            target/distrib/*
            release-notes.md

  publish:
    needs:
      - build-local-artifacts
      - build-global-artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist-artifacts
      - name: Flatten downloaded artifacts
        shell: bash
        run: |
          mkdir -p release-assets
          find dist-artifacts -type f -maxdepth 4 -exec cp {} release-assets/ \;
      - name: Validate release assets
        shell: bash
        run: |
          set -euo pipefail
          required=(
            "codecompass-aarch64-apple-darwin.tar.gz"
            "codecompass-aarch64-apple-darwin.tar.gz.sha256"
            "codecompass-x86_64-apple-darwin.tar.gz"
            "codecompass-x86_64-apple-darwin.tar.gz.sha256"
            "codecompass-aarch64-unknown-linux-musl.tar.gz"
            "codecompass-aarch64-unknown-linux-musl.tar.gz.sha256"
            "codecompass-x86_64-unknown-linux-musl.tar.gz"
            "codecompass-x86_64-unknown-linux-musl.tar.gz.sha256"
            "codecompass-x86_64-pc-windows-msvc.zip"
            "codecompass-x86_64-pc-windows-msvc.zip.sha256"
            "release-notes.md"
          )
          missing=0
          for file in "${required[@]}"; do
            if [[ ! -f "release-assets/${file}" ]]; then
              echo "Missing required release asset: ${file}" >&2
              missing=1
            fi
          done
          total="$(find release-assets -maxdepth 1 -type f | wc -l | tr -d ' ')"
          echo "Release assets found: ${total}"
          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi
      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          body_path: release-assets/release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}

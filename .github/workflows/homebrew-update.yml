name: homebrew-update

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v0.2.0)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  update-formula:
    runs-on: ubuntu-latest
    env:
      SOURCE_REPO: signalridge/cruxe
      TAP_REPO: signalridge/homebrew-tap
    steps:
      - name: Resolve release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch release metadata
        id: assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          gh release view "$TAG" --repo "$SOURCE_REPO" --json assets > assets.json

          pick_asset() {
            local pattern="$1"
            jq -r --arg pattern "$pattern" '.assets[] | select(.name | test($pattern)) | .name' assets.json | head -n 1
          }

          mac_arm=$(pick_asset "aarch64-apple-darwin\\.tar\\.gz$")
          mac_x86=$(pick_asset "x86_64-apple-darwin\\.tar\\.gz$")
          linux_arm=$(pick_asset "aarch64-unknown-linux-(musl|gnu)\\.tar\\.gz$")
          linux_x86=$(pick_asset "x86_64-unknown-linux-(musl|gnu)\\.tar\\.gz$")

          for value in "$mac_arm" "$mac_x86" "$linux_arm" "$linux_x86"; do
            if [ -z "$value" ] || [ "$value" = "null" ]; then
              echo "Failed to resolve all required release assets" >&2
              exit 1
            fi
          done

          gh release download "$TAG" --repo "$SOURCE_REPO" --pattern "${mac_arm}.sha256" --dir .
          gh release download "$TAG" --repo "$SOURCE_REPO" --pattern "${mac_x86}.sha256" --dir .
          gh release download "$TAG" --repo "$SOURCE_REPO" --pattern "${linux_arm}.sha256" --dir .
          gh release download "$TAG" --repo "$SOURCE_REPO" --pattern "${linux_x86}.sha256" --dir .

          extract_checksum() {
            local checksum_file="$1"
            awk 'match($0, /[0-9A-Fa-f]{64}/) { print tolower(substr($0, RSTART, RLENGTH)); found=1; exit } END { if (!found) exit 1 }' "$checksum_file"
          }

          mac_arm_sha="$(extract_checksum "${mac_arm}.sha256" 2>/dev/null || true)"
          mac_x86_sha="$(extract_checksum "${mac_x86}.sha256" 2>/dev/null || true)"
          linux_arm_sha="$(extract_checksum "${linux_arm}.sha256" 2>/dev/null || true)"
          linux_x86_sha="$(extract_checksum "${linux_x86}.sha256" 2>/dev/null || true)"

          for checksum in "$mac_arm_sha" "$mac_x86_sha" "$linux_arm_sha" "$linux_x86_sha"; do
            if [[ ! "$checksum" =~ ^[0-9a-f]{64}$ ]]; then
              echo "Failed to resolve all required checksums" >&2
              exit 1
            fi
          done

          {
            echo "mac_arm_asset=$mac_arm"
            echo "mac_x86_asset=$mac_x86"
            echo "linux_arm_asset=$linux_arm"
            echo "linux_x86_asset=$linux_x86"
            echo "mac_arm_sha=$mac_arm_sha"
            echo "mac_x86_sha=$mac_x86_sha"
            echo "linux_arm_sha=$linux_arm_sha"
            echo "linux_x86_sha=$linux_x86_sha"
          } >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update Formula/cruxe.rb
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          version="${TAG#v}"
          base_url="https://github.com/${SOURCE_REPO}/releases/download/${TAG}"

          cat > tap/Formula/cruxe.rb <<RUBY
          class Cruxe < Formula
            desc "Code search and navigation engine for AI coding assistants"
            homepage "https://github.com/signalridge/cruxe"
            version "${version}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${base_url}/${{ steps.assets.outputs.mac_arm_asset }}"
                sha256 "${{ steps.assets.outputs.mac_arm_sha }}"
              else
                url "${base_url}/${{ steps.assets.outputs.mac_x86_asset }}"
                sha256 "${{ steps.assets.outputs.mac_x86_sha }}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${base_url}/${{ steps.assets.outputs.linux_arm_asset }}"
                sha256 "${{ steps.assets.outputs.linux_arm_sha }}"
              else
                url "${base_url}/${{ steps.assets.outputs.linux_x86_asset }}"
                sha256 "${{ steps.assets.outputs.linux_x86_sha }}"
              end
            end

            def install
              bin.install "cruxe"
            end

            test do
              output = shell_output("#{bin}/cruxe --version")
              assert_match(version.to_s, output)
            end
          end
          RUBY

      - name: Create pull request in tap repository
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap
          commit-message: "chore(formula): update cruxe to ${{ steps.tag.outputs.tag }}"
          branch: "automation/homebrew-${{ steps.tag.outputs.tag }}"
          title: "chore(formula): update cruxe to ${{ steps.tag.outputs.tag }}"
          body: |
            Automated formula update for `${{ steps.tag.outputs.tag }}`.
            - Source release: `https://github.com/${{ env.SOURCE_REPO }}/releases/tag/${{ steps.tag.outputs.tag }}`
            - Trigger: `${{ github.workflow }}`
